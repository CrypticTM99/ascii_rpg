<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ASCII RPG - Created by cryptictm 2025</title>
  <style>
    body {
      background-color: #111;
      color: #0f0;
      font-family: monospace;
      padding: 2px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      text-align: center;
      margin-bottom: 15px;
    }
    #main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 8px;
      width: 100%;
      max-width: 1500px;
      align-items: stretch;
    }
    .card {
      border: 2px solid #0f0;
      border-radius: 2px;
      padding: 12px;
      background: #000;
      box-shadow: 0 0 8px #060;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 320px;
      height: 100%;
    }
    .ascii-art {
      white-space: pre;
      text-align: center;
      margin-bottom: 6px;
      color: rgba(36, 207, 36, 0.734);
      font-size: 16px;
    }
    button {
      margin: 4px 0;
      padding: 6px 12px;
      background: #020;
      color: #0f0;
      border: 1px solid #0f0;
      border-radius: 18px;
      cursor: pointer;
      width: 85%;
      max-width: 100px;
    }
    button:hover {
      background: #030;
    }
    #enemyBox {
      border: 2px solid #0f0;
      background: #000;
      width: 100%;
      max-width: 100%;
      border: 1.5px dashed rgb(52, 142, 162);
      min-height: 120px;
      text-align: center;
      white-space: pre;
      font-size: 14px;
      padding: 10px;
      margin-top: 10px;
      overflow-y: auto;
    }
    #log {
      border: 2px solid #0f0;
      background: #000;
      width: 100%;
      max-width: 100%;
      border: 1.5px dashed rgb(52, 142, 162);
      height: 160px;
      max-height: 160px;
      font-size: 14px;
      padding: 10px;
      margin-top: 10px;
      overflow-y: auto;
      display: block;
      text-align: left;
      white-space: normal;
    }
    .log-entry {
      color: #9f9;
      line-height: 1.2;
      word-break: break-word;
    }
    #inventory, #shop {
      margin-top: -10px;
      border: 1px solid #0f0;
      padding: 10px;
      background: #000000;
      width: 100%;
      max-width: 1300px;
    }
    #inventory h3, #shop h3 {
      margin-top: 0;
      text-align: center;
    }
    .inventory-grid, .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
      gap: 10px;
      font-size: 12px;
    }
    .gear-visual {
      font-size: 16px;
      white-space: pre;
      text-align: center;
      margin-top: 10px;
      border-top: 1px dashed #0f0;
      padding-top: 6px;
    }
  </style>
</head>
<body>
  <div style="position:fixed; top:6px; right:8px; z-index:10">
    <button id="saveMenuBtn" onclick="toggleSaveMenu()" style="width:auto;max-width:none;padding:4px 8px">⋮</button>
    <div id="saveMenu" style="display:none; position:absolute; right:0; margin-top:4px; background:#000; border:1px solid #0f0; padding:6px; min-width:220px">
      <div style="text-align:center;margin-bottom:4px"><b>Save/Load</b></div>
      <div id="saveSlots"></div>
      <div style="text-align:center;margin-top:6px">
        <button onclick="closeSaveMenu()" style="max-width:none">Close</button>
      </div>
    </div>
  </div>
  <h1>ASCII RPG - Update 0.6.0</h1>

  <div id="main">
    <div class="card">
      <div class="ascii-art" id="townAscii">
       
 ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ 
 ||H |||E |||A |||R |||T |||H |||G |||L |||E |||N ||
 ||__|||__|||__|||__|||__|||__|||__|||__|||__|||__||
 |/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|
            
      </div>
      <h3>TOWN AREA</h3>
      <button onclick="tavernJob()">Tavern Job</button>
      <button onclick="blacksmith()">Blacksmith</button>
      <button onclick="rest()">Rest</button>
      <button onclick="toggleQuestBoard()">Quest Board</button>
      <button onclick="toggleSkillTree()">Skill Tree</button>
      <button onclick="togglePetSystem()">Pet System</button>
      <button onclick="toggleCrafting()">Crafting</button>
      <button onclick="toggleAchievements()">Achievements</button>
      <button onclick="toggleDailyChallenges()">Daily Challenges</button>
      <button id="arenaBtn" onclick="toggleArena()" style="display:none">Ashfall Arena</button>
    </div>

    <div class="card">
      <div class="ascii-art">    
 ____ ____ ____ ____ ____ ____ ____ ____ 
||D |||U |||N |||G |||E |||O |||N |||S ||
||__|||__|||__|||__|||__|||__|||__|||__||
|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|
      </div>
      <h3>-</h3>
      <button onclick="enterDungeon('Rat Caves')">Rat Caves</button>
      <button onclick="enterDungeon('Old Catacombs')">Old Catacombs</button>
      <button onclick="enterDungeon('Ashen Rift')">Ashen Rift</button>
      <button onclick="startDungeonExploration()">Explore Dungeon</button>
    </div>

    <div class="card">
      <div class="ascii-art">
  ____ ____ ____ ____ ____ ____ 
||C |||O |||M |||B |||A |||T ||
||__|||__|||__|||__|||__|||__||
|/__\|/__\|/__\|/__\|/__\|/__\|
      </div>
      <h3>-</h3>
      <button onclick="combat('attack')">Attack</button>
      <button onclick="combat('spell')">Cast Spell</button>
      <button onclick="combat('item')">Use Item</button>
      <button onclick="combat('run')">Run</button>
      <div id="enemyBox"></div>
      <div id="log"></div>
    </div>

    <div class="card">
      <div class="ascii-art">
____ ____ ____ ____ ____ ____ 
||T |||R |||A |||V |||E |||L ||
||__|||__|||__|||__|||__|||__||
|/__\|/__\|/__\|/__\|/__\|/__\|  
      </div>
      <h3>|</h3>
      <button onclick="travel('Ashfall')">To Ashfall</button>
      <button onclick="travel('Hearthglen')">To Hearthglen</button>
      <button id="challengeVorthalonBtn" onclick="challengeVorthalon()" style="display:none">Challenge Vorthalon</button>
    </div>
  </div>

  <div class="card" id="dungeonExplorationCard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art">
 ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ ____ 
||D |||U |||N |||G |||E |||O |||N |||  |||E |||X |||P |||L |||O |||R |||E |||R ||
||__|||__|||__|||__|||__|||__|||__|||__|||__|||__|||__|||__|||__|||__|||__|||__||
|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|/__\|
    </div>
    <h3>Dungeon Explorer</h3>
    <div id="dungeonStatus" style="text-align:center;margin-bottom:6px;font-size:14px"></div>
    <div id="dungeonMap" style="text-align:center;margin-bottom:10px;font-family:monospace;font-size:12px;color:#0f0"></div>
    <div id="dungeonActions" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px"></div>
    <div id="dungeonDescription" style="border:1px solid #0f0;background:#000;padding:8px;margin-bottom:8px;min-height:60px;font-size:13px;color:#9f9"></div>
    <div id="dungeonLoot" style="border:1px solid #0f0;background:#000;padding:8px;margin-bottom:8px;min-height:40px;font-size:13px;color:#ff9;display:none"></div>
    <div style="text-align:center">
      <button onclick="exitDungeonExploration()" style="max-width:none;width:auto">Exit Dungeon</button>
    </div>
  </div>

  <div class="card" id="questBoard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art" id="questAscii">
      / _ \| | | | ____/ ___|_   _| | __ ) / _ \  / \  |  _ \|  _ \ 
      | | | | | | |  _| \___ \ | |   |  _ \| | | |/ _ \ | |_) | | | |
      | |_| | |_| | |___ ___) || |   | |_) | |_| / ___ \|  _ <| |_| |
       \__\_\\___/|_____|____/ |_|   |____/ \___/_/   \_\_| \_\____/ 
    </div>
    <h3>Quest Board</h3>
    <div id="questList" class="inventory-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
    <div style="margin-top:6px;text-align:center">
      <button id="abandonQuestBtn" onclick="abandonQuest()" disabled>Abandon Active Quest</button>
    </div>
  </div>

  <div class="card" id="skillTreeCard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art">
 

      __      _           ____   _  _
      (_  |/  |  |  |      | |_) |_ |_
      __) |\ _|_ |_ |_     | | \ |_ |_
      
         
    </div>
    <h3>Skill Tree</h3>
    <div id="classSelect" style="margin-bottom:8px;text-align:center">
      <span>Class:</span>
      <select id="classPicker" onchange="setPlayerClass(this.value)">
        <option value="None">None</option>
        <option value="Warrior">Warrior</option>
        <option value="Mage">Mage</option>
        <option value="Rogue">Rogue</option>
      </select>
      <span style="margin-left:10px">Unspent Points: <b id="skillPointsLabel">0</b></span>
    </div>
    <div class="inventory-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); width:100%">
      <div style="border:1px dashed #0f0;padding:6px;text-align:center">
        <div><b>Power</b> (+1 attack damage / point)</div>
        <div>Current: <span id="skillPowerVal">0</span></div>
        <button onclick="allocatePoint('power')">Allocate</button>
      </div>
      <div style="border:1px dashed #0f0;padding:6px;text-align:center">
        <div><b>Focus</b> (+1 spell damage / point)</div>
        <div>Current: <span id="skillFocusVal">0</span></div>
        <button onclick="allocatePoint('focus')">Allocate</button>
      </div>
      <div style="border:1px dashed #0f0;padding:6px;text-align:center">
        <div><b>Vitality</b> (+5 max HP / point)</div>
        <div>Current: <span id="skillVitalityVal">0</span></div>
        <button onclick="allocatePoint('vitality')">Allocate</button>
      </div>
    </div>
  </div>
  
  <div class="card" id="arenaCard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art">
      _    ____  _____ _   _    _    
      / \  |  _ \| ____| \ | |  / \   
     / _ \ | |_) |  _| |  \| | / _ \  
    / ___ \|  _ <| |___| |\  |/ ___ \ 
   /_/   \_\_| \_\_____|_| \_/_/   \_\
      
    </div>
    <h3>Ashfall Arena</h3>
    <div id="arenaStatus" style="text-align:center;margin-bottom:6px"></div>
    <div id="arenaActions" class="inventory-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </div>

  <div class="card" id="petCard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art">
      /\\___/\\
     (  o o  )
     (  =^=  ) 
      (______)
         |  |
        _|  |_
    </div>
    <h3>Pet Companion</h3>
    <div id="petStatus" style="text-align:center;margin-bottom:6px"></div>
    <div id="petActions" class="inventory-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </div>

  <div class="card" id="craftingCard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art">
      /\\___/\\
     (  🔨🔨  )
     (  =^=  ) 
      (______)
         |  |
        _|  |_
    </div>
    <h3>Crafting Workshop</h3>
    <div id="craftingRecipes" class="inventory-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </div>

  <div class="card" id="achievementsCard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art">
      /\\___/\\
     (  🏆🏆  )
     (  =^=  ) 
      (______)
         |  |
        _|  |_
    </div>
    <h3>Achievements</h3>
    <div id="achievementsList" class="inventory-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </div>

  <div class="card" id="dailyChallengesCard" style="display:none; margin-top:8px; width:100%; max-width:1300px;">
    <div class="ascii-art">
      /\\___/\\
     (  🌟🌟  )
     (  =^=  ) 
      (______)
         |  |
        _|  |_
    </div>
    <h3>Daily Challenges</h3>
    <div id="dailyChallengeStatus" style="text-align:center;margin-bottom:6px"></div>
    <div id="dailyChallengeActions" class="inventory-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));"></div>
  </div>

  <div id="inventory" style="position:relative">
    <h3>Inventory</h3>
    <div class="inventory-grid" id="inventoryGrid"></div>
    <div class="gear-visual" id="gearVisual"></div>
    <div style="text-align:center;margin-top:6px">
      <button id="equipBtn" onclick="toggleEquipmentWindow()" style="max-width:none;width:auto">Equipment</button>
    </div>
    <div id="equipmentPanel" style="display:none; position:absolute; top:8px; right:-260px; width:240px; border:1px solid #0f0; background:#000; padding:8px; box-shadow:0 0 8px #060; z-index:5">
      <div style="text-align:center;margin-bottom:6px"><b>Equipment</b></div>
      <div id="equipmentPanelBody" style="font-size:12px"></div>
      <div style="text-align:center;margin-top:6px">
        <button onclick="toggleEquipmentWindow()" style="max-width:none;width:auto">Close</button>
      </div>
    </div>
  </div>

  <div id="shop">
    <h3>MARKETPLACE</h3>
    <p style="text-align:center">(Refreshes every 5 minutes)</p>
    <div class="shop-grid" id="shopGrid"></div>
  </div>

  <script>
    let player = {
      hp: 100,
      maxHp: 100,
      gold: 10,
      town: "Hearthglen",
      gearLevel: 0,
      level: 1,
      xp: 0,
      inventory: {
        "Iron Ore": 0,
        "Leather Scraps": 0,
        "Arcane Crystal": 0,
        "Shadow Essence": 0,
        "Ember Core": 0,
        "Rusty Dagger": 0,
        "Ancient Scroll": 0,
        "Phoenix Feather": 0,
        "Star Fragment": 0,
        "Prestige Token": 0
      },
      equipment: {
        weapon: null
      }
    };

    let currentEnemy = null;
    let shopItems = [];
    let questPool = [];
    let availableQuests = [];
    let activeQuest = null;
    let questRefreshTimer = null;
    let inCombat = false;
    let bossWeaponsCache = null; // cached list for drop filtering

    // Skill system state
    let skillState = {
      className: 'None',
      pointsUnspent: 0,
      power: 0,
      focus: 0,
      vitality: 0
    };

    // Arena system state
    let arena = {
      rep: 0,
      unlocked: false,
      inArena: false,
      mode: null, // 'duel' | 'waves' | null
      wave: 0
    };

    // Achievement system state
    let achievements = {
      unlocked: [],
      progress: {}
    };

    // Pet/Companion system state
    let pets = {
      active: null,
      owned: [],
      happiness: 100,
      lastFed: Date.now()
    };

    // Crafting system state
    let crafting = {
      recipes: {},
      discovered: []
    };

    // Daily challenge system
    let dailyChallenges = {
      current: null,
      lastRefresh: Date.now(),
      streak: 0
    };

    // Dungeon exploration system
    let dungeonExploration = {
      active: false,
      currentDungeon: null,
      currentFloor: 1,
      currentRoom: 1,
      maxFloors: 5,
      roomsPerFloor: 4,
      exploredRooms: [],
      currentEncounter: null,
      lootFound: [],
      dialogueState: null
    };

    // Prestige system
    let prestige = {
      level: 0,
      points: 0,
      totalLifetime: {
        gold: 0,
        xp: 0,
        quests: 0,
        bosses: 0
      }
    };

    // Item drop system
    const itemPool = {
      // Junk items (common, low value)
      "Rusty Nail": { value: 1, rarity: "common", type: "junk" },
      "Broken Glass": { value: 1, rarity: "common", type: "junk" },
      "Rotten Wood": { value: 2, rarity: "common", type: "junk" },
      "Dirty Rag": { value: 1, rarity: "common", type: "junk" },
      "Bent Coin": { value: 3, rarity: "common", type: "junk" },
      
      // Basic materials (uncommon, medium value)
      "Iron Ore": { value: 5, rarity: "uncommon", type: "material" },
      "Leather Scraps": { value: 4, rarity: "uncommon", type: "material" },
      "Copper Wire": { value: 6, rarity: "uncommon", type: "material" },
      "Silver Dust": { value: 8, rarity: "uncommon", type: "material" },
      
      // Valuable items (rare, high value)
      "Arcane Crystal": { value: 15, rarity: "rare", type: "magical" },
      "Shadow Essence": { value: 12, rarity: "rare", type: "magical" },
      "Ember Core": { value: 18, rarity: "rare", type: "magical" },
      "Gold Nugget": { value: 25, rarity: "rare", type: "valuable" },
      "Ancient Coin": { value: 30, rarity: "rare", type: "valuable" },
      "Dragon Scale": { value: 50, rarity: "epic", type: "valuable" },
      // Hearthglen tier-2 drops (new)
      "Boar Tusk": { value: 9, rarity: "uncommon", type: "material" },
      "Bandit Emblem": { value: 14, rarity: "rare", type: "valuable" },
      "Warden Leaf": { value: 7, rarity: "common", type: "material" },
      "Spider Silk": { value: 12, rarity: "uncommon", type: "material" },
      "Cave Moss": { value: 6, rarity: "common", type: "material" },
      "Runed Shard": { value: 20, rarity: "rare", type: "magical" },

      // Arena exclusive rewards
      "Arena Token": { value: 22, rarity: "uncommon", type: "arena" },
      "Champion's Laurel": { value: 60, rarity: "rare", type: "arena" },

      // Boss-only weapons (Vorthalon)
      "Starbinder's Edge": { value: 120, rarity: "rare", type: "boss_weapon" },
      "Celestial Halberd": { value: 140, rarity: "rare", type: "boss_weapon" },
      "Aetheric Longbow": { value: 130, rarity: "rare", type: "boss_weapon" },
      "Singularity Mace": { value: 150, rarity: "rare", type: "boss_weapon" },
      "Chrono Dagger": { value: 110, rarity: "rare", type: "boss_weapon" },

      // Pet items
      "Pet Treat": { value: 8, rarity: "uncommon", type: "pet" },
      "Magic Collar": { value: 25, rarity: "rare", type: "pet" },
      "Dragon Scale Harness": { value: 45, rarity: "epic", type: "pet" },

      // Crafting materials
      "Enchanted Thread": { value: 12, rarity: "uncommon", type: "crafting" },
      "Mystic Gem": { value: 20, rarity: "rare", type: "crafting" },
      "Ancient Rune": { value: 35, rarity: "epic", type: "crafting" },
      "Void Essence": { value: 50, rarity: "epic", type: "crafting" },

      // Prestige rewards
      "Prestige Token": { value: 100, rarity: "epic", type: "prestige" },
      "Eternal Shard": { value: 200, rarity: "epic", type: "prestige" }
    };

    // Pet system definitions
    const petTypes = {
      "Wolf Pup": {
        ascii: `
    /\\___/\\
   (  o o  )
   (  =^=  ) 
    (______)
       |  |
      _|  |_`,
        bonus: { attack: 2, type: "combat" },
        happinessDecay: 0.5
      },
      "Mystic Cat": {
        ascii: `
    /\\___/\\
   (  * *  )
   (  =^=  ) 
    (______)
       |  |
      _|  |_`,
        bonus: { spell: 3, type: "magic" },
        happinessDecay: 0.3
      },
      "Guardian Owl": {
        ascii: `
      /\\___/\\
     (  o o  )
     (  =^=  ) 
      (______)
         |  |
        _|  |_`,
        bonus: { defense: 1, type: "defense" },
        happinessDecay: 0.4
      },
      "Dragon Hatchling": {
        ascii: `
    /\\___/\\
   (  🔥🔥  )
   (  =^=  ) 
    (______)
       |  |
      _|  |_`,
        bonus: { all: 1, type: "legendary" },
        happinessDecay: 0.8
      }
    };

    // Crafting recipes
    const craftingRecipes = {
      "Magic Sword": {
        materials: { "Iron Ore": 3, "Enchanted Thread": 1, "Mystic Gem": 1 },
        result: { name: "Magic Sword", value: 80, rarity: "rare", type: "crafted_weapon" },
        difficulty: 2
      },
      "Healing Potion": {
        materials: { "Warden Leaf": 2, "Cave Moss": 1, "Spider Silk": 1 },
        result: { name: "Healing Potion", value: 25, rarity: "uncommon", type: "consumable" },
        difficulty: 1
      },
      "Stealth Cloak": {
        materials: { "Leather Scraps": 4, "Shadow Essence": 2, "Enchanted Thread": 1 },
        result: { name: "Stealth Cloak", value: 60, rarity: "rare", type: "crafted_armor" },
        difficulty: 2
      },
      "Arcane Staff": {
        materials: { "Ancient Rune": 1, "Void Essence": 1, "Arcane Crystal": 3 },
        result: { name: "Arcane Staff", value: 120, rarity: "epic", type: "crafted_weapon" },
        difficulty: 3
      }
    };

    // Achievement definitions
    const achievementList = {
      "First Blood": { name: "First Blood", desc: "Win your first battle", reward: { gold: 10, xp: 20 } },
      "Rat Slayer": { name: "Rat Slayer", desc: "Defeat 10 rats", reward: { gold: 25, xp: 50 }, progress: { type: "kill", target: "rat", count: 10 } },
      "Quest Master": { name: "Quest Master", desc: "Complete 5 quests", reward: { gold: 50, xp: 100 }, progress: { type: "quest", count: 5 } },
      "Dungeon Crawler": { name: "Dungeon Crawler", desc: "Visit all dungeons", reward: { gold: 75, xp: 150 }, progress: { type: "dungeon", count: 3 } },
      "Boss Slayer": { name: "Boss Slayer", desc: "Defeat Vorthalon", reward: { gold: 200, xp: 500, item: "Prestige Token" } },
      "Craftsman": { name: "Craftsman", desc: "Craft 3 items", reward: { gold: 100, xp: 200 }, progress: { type: "craft", count: 3 } },
      "Pet Lover": { name: "Pet Lover", desc: "Own 2 pets", reward: { gold: 150, xp: 300 }, progress: { type: "pet", count: 2 } },
      "Arena Champion": { name: "Arena Champion", desc: "Win 10 arena battles", reward: { gold: 300, xp: 600 }, progress: { type: "arena", count: 10 } }
    };

    // Daily challenge types
    const dailyChallengeTypes = {
      "Kill Spree": { name: "Kill Spree", desc: "Defeat 20 enemies today", reward: { gold: 100, xp: 200, item: "Pet Treat" }, type: "kill", target: 20 },
      "Quest Rush": { name: "Quest Rush", desc: "Complete 3 quests today", reward: { gold: 150, xp: 300, item: "Enchanted Thread" }, type: "quest", target: 3 },
      "Crafting Day": { name: "Crafting Day", desc: "Craft 2 items today", reward: { gold: 200, xp: 400, item: "Mystic Gem" }, type: "craft", target: 2 },
      "Pet Care": { name: "Pet Care", desc: "Feed your pet 5 times today", reward: { gold: 80, xp: 160, item: "Magic Collar" }, type: "feed", target: 5 }
    };

    const townAsciiArt = {
      "Hearthglen": `
    --   TOWN OF  HEARTHGLEN --
  |_|  |_|\__,_|_| |_|\__,_|\___|_| |_|\__,_|
      `,
      "Ashfall": `
TOWN OF
     /\\
     /  \\    _   _  ___  _   _ _ 
    / /\\ \\ S  | | |H |/ _F \\|A| L| L| |
   / ____ \\ | (_) | |_| | |
  /_/    \\_\
                             
                             
      `
    };

    const enemyAscii = {
      "Mutated Rat": `
     (\--._            
     (   \--._..--._  
     /  /○\              )\{} 
    (    .-.-;"\\      | 
     \\《_/\\_.-'_.-'\\    | 
          \--'     \----'`,
      "Small Rat": `
     (\\_./) 
     (o.o ) 
     > ^ <`,
      "Rat Gang": `
    (\\_._/) (\\_._/) (\\_._/) 
    ( o.o ) ( o.o ) ( o.o ) 
    (> ^ <) (> ^ <) (> ^ <)`,
      "Skeleton": `
      .-.
     (o.o) 
      |=|  
     __|__ 
   //.=|=.\\\\
  // .=|=. \\\\
  \\\\ .=|=. //`,
      "Ghoul": `
   .-"      "-.
  /            \\
 |,  .-.  .-.  ,|
 | )(_o/  \\o_)( |
 |/     /\\     \\|
 (_     ^^     _)
  \\__|IIIIII|__/`,
      "Necromancer": `
      /^\\
     /   \\    □
    /#  | # \\ |
   /   |   \\  |
  /    |    \\ |
  |  (   )  | |||
  |   | |   |  |
  | %%  | |  %% |
   \\__|_|__/  □
   #@      @# `,
      "Fire Imp": `
     🔥    🔥
    € (    )€
    ( ¤ (  ¤ )
   €( (   )  )€
      )V__V (  ¡
     (  vv  )   -
      (   )
       ( )`,
      "Lava Serpent": `
    /^\/^\
    ,-   |,-:
   _|O__| O|:
 / ''   /~ \ :
 \__;~*;__|___/
    ;~; \   \     
   ;~*;  \   \
   kVk    \    \\\
        #^🔥#^#^🔥#^#^#🔥^#🔥^#^#`,
      "Ash Golem": `
          ___
         _[_|_/]]|_
        (  &  &   )
       /|  .  |-\
      / |     | -\
      ●  |     |  ●
         '-----'`,
      "Gladiator Brutus": `
      __
   _ /__\ _
  ( '_  _' )
   |  \/  |   ====
   | |\/| |  |____|
   |_|  |_|   /  \
    BRUTUS`,
      "Gladiator Nyx": `
    .-.
   (o_o)  <{==* 
    | |\
   _| |_\
  /_____/
    NYX`,
      "Arena Crusher": `
     _____
   _|_   _|_
  / _ \ / _ \
 | |_| | |_| |
  \___/ \___/
   [CRUSH]`,
      "Goblin": `
       (------;_),-.
     |~-(),()/_/
       (,___,)
      ,-/&&|-,___
     / /).:. ('--._)
    {_[ (_,_)
        | Y |
       /  |  }
       """ """ `,
      "Giant Rat": `
        /\\___/\\
       (  o o  )
       (  =^=  ) 
        (______)
         |  |  |
         |  |  |
        _|  |  |_`,
      "Rat Gang(B)": `
      /\\___/\\  /\\___/\\  /\\___/\\
     (  o o  )(  o o  )(  o o  )
     (  =^=  ) (  =^=  ) (  =^=  ) 
      (______)  (______)  (______)
         |  |      |  |      |  |
         |  |      |  |      |  |
        _|  |_    _|  |_    _|  |_`,
      "Zombie": `
        .-.
       (X.X)
        |=|
       __|__
      /  |  \
     /   |   \
    /____|____\\`,
    "Doomed Paladin": `_,.
    ,\` -.)
   ( _/-\\-._
  /,|\`--._,-^|            ,
  \\_| |\`-._/||          ,'|
    |  \`-, / |         /  /
    |     || |        /  /
     \`r-._||/   __   /  /
 __,-<_     )\`-/  \`./  /
'  \\   \`---'   \\   /  /
    |           |./  /
    /           //  /
\\_/' \\         |/  /
 |    |   _,^-'/  /
 |    , \`\`  (\\/  /_
  \\,.->._    \\X-=/^
  (  /   \`-._//^\`
   \`Y-.____(__}
    |     {__)
          (),`,
      "Wraith": `
      .-""""""-.
     /          \\
    |  (  ) (  ) |
    |  :\\  / :  |
     \\   \\/   /
      '-......-'`,
      "Void Cat Knight": `
        /\\___/\\
       |  x x  |
       |  =^=  |
        |_888__|
       /|     |\\
      / |     | \\
     /  |     |  \\
    /___|_____|___\\`,
      "Shadow Beast": `
        /\\___/\\
       (-------)
       (  * *  )
       (9 =%= 9 ) 
        (_^__^__)
         |  |  |
         |  |  |
        _|  |  |_
       /  /   \\  \\
      /  /     \\  \\
     /__/       \\__\\`,
      "Magma Elemental": `
        /\\___/\\
       (  🔥🔥  )
       (  9 =^= 9 ) 
        (________)
       [[|  |  |]]
         |  |  |
        _|  |  |_
       /  /   \\  \\
      /  /     \\  \\
     /__/       \\__\\`,
      "Phoenix": ` _,="( _  )"=,_
_,' 🔥   \_>\_/ 🔥   ',_
.7,🔥     {  }    🔥 ,\.
 '/:,  .m  m.  ,:\'
   ')",(/  \),"('
      '{'!!'}'`,
      "Crystal Golem": `
        /\\___/\\
       (  💎💎  )
       (  &  &  ) 
        (______)
         |  |  |
         |  |  |
        _|  |  |_
       /  /   \\  \\
      /  /     \\  \\
     /__/       \\__\\`,
      "Skitterspawn": `
         \\     /
  --- (o o) ---
     / \\_/ \\`,
      "Angry Leeroy": `
  [o'_'o]
      :-:
       |/|\\
       | |---|===-ffff>
       |\
      / \ `,
      "Vorthalon, Starbinder of Endlight": `
         ____====-_  _-====____
            _--^^^#####//      \\\\#####^^^--_
         _-^##########// (    ) \\\\##########^-_
        -############//  |\\^^/|  \\\\############-
      _/############//   (@::@)   \\\\############\\_
     /#############((     \\\\//     ))#############\\
    -###############\\\\    (oo)    //###############-
   -#################\\\\  / UUU \\  //#################-
  -##/|###############\\\\/  (_)  \\\\//###############|\\##-
  |/ |#/\#/\#/\#/\#/\#/\#/\#/\#/\#/\#/\#/\#/\#/\#/\| \\|
  || |                      █                       | ||
  || |       Vorthalon, Starbinder of Endlight      | ||
  \\_|________________________________________________|_/
`,
      "Cave Stalker": `[o'_'o]
      :-:
      :|/|\\ 99---|--|===-ffff>
      =--:[|34=56|---|===-ffff>
      | "|\
     :<- / \ `,
     "Ruined Spider": `\_______/
    {}
\_\(e_r)/_/
 _//"\\_
  /   \ `,
      "Rat King": `
    ╔═══════════════╗
    ║  ╔═══════════╗ ║
    ║  ║  ╔═══════╗ ║ ║
    ║  ║  ║  ╔═══╗ ║ ║ ║
    ║  ║  ║  ║ @ ║ ║ ║ ║
    ║  ║  ║  ╚═══╝ ║ ║ ║
    ║  ║  ╚═══════╝ ║ ║
    ║  ╚═══════════╝ ║
    ╚═══════════════╝`,
      "Lich King": `
         ╔═══════════╗
        ╱║  ╔═══════╗║╲
       ╱ ║  ║  ╔═══╗ ║║ ╲
      ╱  ║  ║  ║   ║ ║║  ╲
     ╱   ║  ║  ║ @ ║ ║║   ╲
    ╱    ║  ║  ╚═══╝ ║║    ╲
   ╱     ║  ╚═══════╝║     ╲
  ╱      ╚═══════════╝      ╲`
     };

    // Dungeon exploration data structures
    const dungeonData = {
      "Rat Caves": {
        name: "Rat Caves",
        description: "Dark, damp tunnels filled with mutated rodents",
        floors: [
          {
            name: "Entrance Chamber",
            description: "The entrance to the caves. Water drips from the ceiling.",
            encounters: [
              { type: "combat", enemy: "Small Rat", dialogue: "A small rat scurries out from the shadows!" },
              { type: "loot", item: "Rusty Dagger", description: "You find an old dagger covered in rust." },
              { type: "dialogue", npc: "Lost Merchant", text: "I've been trapped here for days! Please help me escape!" },
              { type: "combat", enemy: "Mutated Rat", dialogue: "A larger, more aggressive rat blocks your path!" }
            ]
          },
          {
            name: "Nesting Grounds",
            description: "Piles of bones and debris mark the rat nesting area.",
            encounters: [
              { type: "combat", enemy: "Rat Gang", dialogue: "A group of rats attacks in formation!" },
              { type: "loot", item: "Leather Scraps", description: "You discover some useful leather scraps." },
              { type: "combat", enemy: "Giant Rat", dialogue: "A massive rat emerges from the shadows!" },
              { type: "dialogue", npc: "Wounded Adventurer", text: "I was exploring deeper when I got ambushed. Be careful ahead!" }
            ]
          },
          {
            name: "Deep Tunnels",
            description: "The air grows thick with an unnatural stench.",
            encounters: [
              { type: "combat", enemy: "Skitterspawn", dialogue: "Something unnatural skitters toward you!" },
              { type: "loot", item: "Arcane Crystal", description: "A glowing crystal pulses with magical energy." },
              { type: "dialogue", npc: "Ancient Spirit", text: "The corruption runs deep here. Only the brave may pass." },
              { type: "combat", enemy: "Rat Gang(B)", dialogue: "A second wave of rats attacks!" }
            ]
          },
          {
            name: "The Warren",
            description: "The heart of the rat infestation. The walls pulse with corruption.",
            encounters: [
              { type: "combat", enemy: "Mutated Rat", dialogue: "The final guardian blocks your way!" },
              { type: "loot", item: "Iron Ore", description: "You find a vein of pure iron ore." },
              { type: "dialogue", npc: "Rat King", text: "You dare enter my domain? Face my wrath!" },
              { type: "boss", enemy: "Rat King", dialogue: "The massive Rat King emerges from the shadows!" }
            ]
          },
          {
            name: "Sanctuary",
            description: "A hidden chamber untouched by corruption.",
            encounters: [
              { type: "loot", item: "Prestige Token", description: "A rare token of great value!" },
              { type: "dialogue", npc: "Mysterious Figure", text: "You have proven yourself worthy. Take this gift." },
              { type: "loot", item: "Ember Core", description: "A powerful magical core radiates heat." },
              { type: "exit", description: "You have reached the deepest part of the caves." }
            ]
          }
        ]
      },
      "Old Catacombs": {
        name: "Old Catacombs",
        description: "Ancient burial chambers filled with undead horrors",
        floors: [
          {
            name: "Crypt Entrance",
            description: "Stone sarcophagi line the walls. Dust fills the air.",
            encounters: [
              { type: "combat", enemy: "Skeleton", dialogue: "Bones rattle as a skeleton rises from its tomb!" },
              { type: "loot", item: "Shadow Essence", description: "Dark energy swirls around a shadowy essence." },
              { type: "dialogue", npc: "Grave Keeper", text: "These halls have been sealed for centuries. What brings you here?" },
              { type: "combat", enemy: "Ghoul", dialogue: "A ghoul emerges from the shadows, its eyes glowing red!" }
            ]
          },
          {
            name: "Bone Chamber",
            description: "Piles of bones form strange patterns on the floor.",
            encounters: [
              { type: "combat", enemy: "Zombie", dialogue: "A zombie shambles toward you, arms outstretched!" },
              { type: "loot", item: "Ancient Scroll", description: "An old scroll contains forgotten knowledge." },
              { type: "dialogue", npc: "Wraith", text: "The living should not disturb the dead. Turn back now." },
              { type: "combat", enemy: "Necromancer", dialogue: "A necromancer raises his staff, dark magic swirling!" }
            ]
          },
          {
            name: "Shadow Halls",
            description: "Darkness seems to move independently here.",
            encounters: [
              { type: "combat", enemy: "Wraith", dialogue: "A wraith materializes, its form shifting and ethereal!" },
              { type: "loot", item: "Arcane Crystal", description: "A crystal pulses with necromantic energy." },
              { type: "dialogue", npc: "Void Cat Knight", text: "I guard these halls. Prove your worth or perish." },
              { type: "combat", enemy: "Shadow Beast", dialogue: "A creature of pure shadow lunges at you!" }
            ]
          },
          {
            name: "Necromancer's Sanctum",
            description: "The air crackles with dark magic. Skulls line the walls.",
            encounters: [
              { type: "combat", enemy: "Angry Leeroy", dialogue: "LEEEEEEROY JENKINS! A berserker charges!" },
              { type: "loot", item: "Shadow Essence", description: "Pure shadow essence swirls in a crystal vial." },
              { type: "dialogue", npc: "Lich King", text: "You have come far, mortal. But this is where your journey ends!" },
              { type: "boss", enemy: "Lich King", dialogue: "The Lich King rises from his throne, dark magic crackling!" }
            ]
          },
          {
            name: "Eternal Rest",
            description: "A peaceful chamber where the dead find final rest.",
            encounters: [
              { type: "loot", item: "Prestige Token", description: "A token blessed by the spirits of the dead." },
              { type: "dialogue", npc: "Ancient Spirit", text: "You have brought peace to these halls. Take this blessing." },
              { type: "loot", item: "Ember Core", description: "A core that burns with eternal flame." },
              { type: "exit", description: "You have found the deepest chamber of the catacombs." }
            ]
          }
        ]
      },
      "Ashen Rift": {
        name: "Ashen Rift",
        description: "A volcanic rift filled with fire elementals and molten rock",
        floors: [
          {
            name: "Ember Cavern",
            description: "Heat radiates from the walls. Lava flows in the distance.",
            encounters: [
              { type: "combat", enemy: "Fire Imp", dialogue: "A fire imp cackles as it hurls flames at you!" },
              { type: "loot", item: "Ember Core", description: "A core of pure fire energy burns in your hand." },
              { type: "dialogue", npc: "Fire Elemental", text: "The rift calls to those brave enough to enter. Are you worthy?" },
              { type: "combat", enemy: "Lava Serpent", dialogue: "A serpent of molten rock slithers toward you!" }
            ]
          },
          {
            name: "Molten Depths",
            description: "The heat is intense. Molten rock flows like rivers.",
            encounters: [
              { type: "combat", enemy: "Ash Golem", dialogue: "A golem of ash and stone blocks your path!" },
              { type: "loot", item: "Iron Ore", description: "Iron ore forged in the heart of the volcano." },
              { type: "dialogue", npc: "Doomed Paladin", text: "I was once a knight, but the fire consumed my soul. Help me find peace." },
              { type: "combat", enemy: "Magma Elemental", dialogue: "A creature of pure magma rises from the lava!" }
            ]
          },
          {
            name: "Phoenix Nest",
            description: "The legendary phoenix once nested here. Feathers still burn with eternal flame.",
            encounters: [
              { type: "combat", enemy: "Phoenix", dialogue: "A phoenix rises from the ashes, its wings ablaze!" },
              { type: "loot", item: "Phoenix Feather", description: "A feather that burns with eternal fire." },
              { type: "dialogue", npc: "Crystal Golem", text: "I guard the deepest secrets of the rift. Prove yourself." },
              { type: "combat", enemy: "Crystal Golem", dialogue: "A golem of pure crystal reflects the fire's light!" }
            ]
          },
          {
            name: "Vorthalon's Throne",
            description: "The seat of power for the Starbinder of Endlight.",
            encounters: [
              { type: "combat", enemy: "Fire Imp", dialogue: "The final guardians attack!" },
              { type: "loot", item: "Star Fragment", description: "A fragment of a fallen star glows with cosmic energy." },
              { type: "dialogue", npc: "Vorthalon, Starbinder of Endlight", text: "You have come to challenge me? Very well, mortal. Face the power of the stars!" },
              { type: "boss", enemy: "Vorthalon, Starbinder of Endlight", dialogue: "Vorthalon rises, cosmic energy crackling around him!" }
            ]
          },
          {
            name: "Stellar Observatory",
            description: "A chamber that opens to the cosmos itself.",
            encounters: [
              { type: "loot", item: "Prestige Token", description: "A token blessed by the stars themselves." },
              { type: "dialogue", npc: "Cosmic Entity", text: "You have proven yourself worthy of cosmic power. Use it wisely." },
              { type: "loot", item: "Ember Core", description: "A core that burns with the fire of a thousand suns." },
              { type: "exit", description: "You have reached the heart of the stellar rift." }
            ]
          }
        ]
      }
    };

    // Loot ASCII art
    const lootAscii = {
      "Rusty Dagger": `
    ╔═══════╗
    ║   ╔═══╝
    ║   ║
    ╚═══╝`,
      "Leather Scraps": `
    ░░░░░░░░
    ░░░░░░░░
    ░░░░░░░░`,
      "Arcane Crystal": `
      ╔═══════╗
     ╱║  ╔═══╗║╲
    ╱ ║  ║   ║║ ╲
   ╱  ║  ╚═══╝║  ╲
  ╱   ╚═══════╝   ╲`,
      "Iron Ore": `
    ████████
    ████████
    ████████`,
      "Shadow Essence": `
    ╔═══════╗
    ║  ╔═══╗ ║
    ║  ║   ║ ║
    ║  ╚═══╝ ║
    ╚═══════╝`,
      "Ember Core": `
      ╔═══════╗
     ╱║  ╔═══╗║╲
    ╱ ║  ║   ║║ ╲
   ╱  ║  ╚═══╝║  ╲
  ╱   ╚═══════╝   ╲`,
      "Prestige Token": `
    ╔═══════════╗
    ║  ╔═══════╗ ║
    ║  ║   ╔═══╝ ║
    ║  ║   ║     ║
    ║  ╚═══╝     ║
    ╚═══════════╝`,
      "Ancient Scroll": `
    ╔═══════════╗
    ║           ║
    ║  ╔═══════╗ ║
    ║  ║       ║ ║
    ║  ╚═══════╝ ║
    ╚═══════════╝`,
      "Phoenix Feather": `
    ╔═══════╗
    ║  ╔═══╗ ║
    ║  ║   ║ ║
    ║  ╚═══╝ ║
    ╚═══════╝`,
      "Star Fragment": `
      ╔═══════╗
     ╱║  ╔═══╗║╲
    ╱ ║  ║   ║║ ╲
   ╱  ║  ╚═══╝║  ╲
  ╱   ╚═══════╝   ╲`
    };

    function log(message) {
      const logBox = document.getElementById('log');
      if (!logBox) return;
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = message;
      logBox.appendChild(entry);
      // Auto-scroll to bottom so newest entry is visible
      logBox.scrollTop = logBox.scrollHeight;
      updateInventory();
    }

    function updateInventory() {
      const invBox = document.getElementById("inventoryGrid");
      invBox.innerHTML = "";
      for (let item in player.inventory) {
        invBox.innerHTML += item + ": " + player.inventory[item] + "<br>";
      }
      invBox.innerHTML += "Gold: " + player.gold + "<br>";
      invBox.innerHTML += "HP: " + player.hp + "/" + player.maxHp + "<br>";
      invBox.innerHTML += "Level: " + player.level + " (XP: " + player.xp + ")<br>";
      invBox.innerHTML += "Gear Level: +" + player.gearLevel;
      updateGearVisual();
    }

    function updateGearVisual() {
      const el = document.getElementById("gearVisual");
      const armorTier = player.gearLevel;
      const armorLabel = ["Ragged Clothes","Iron Gear","Reinforced Gear","Masterwork Gear","Fully upgraded Gear"][armorTier];
      const weapon = player.equipment.weapon ? player.equipment.weapon : "None";
      const ascii = [
        "   O   ",
        "  /|\\  ",
        "  / \\  "
      ].join("\n");
      el.innerHTML = `
        <div style="white-space:pre;text-align:center">${ascii}</div>
        <div style="margin-top:4px">Armor: <b>${armorLabel}</b></div>
        <div>Weapon: <b>${weapon}</b></div>
      `;
      // Update quests panel too if open
      renderQuestList();
      const ep = document.getElementById('equipmentPanel');
      if (ep && ep.style.display !== 'none') renderEquipmentWindow();
    }

    function tavernJob() {
      if (player.town === "Hearthglen") {
        player.gold += 5;
        player.inventory["Iron Ore"]++;
        log("Worked in Hearthglen Tavern: +5 gold, +1 Iron Ore.");
        updateQuestProgressOnCollect("Iron Ore");
      } else if (player.town === "Ashfall") {
        player.gold += 8;
        if (!player.inventory["Shadow Essence"]) player.inventory["Shadow Essence"] = 0;
        if (!player.inventory["Leather Scraps"]) player.inventory["Leather Scraps"] = 0;
        player.inventory["Shadow Essence"]++;
        player.inventory["Leather Scraps"]++;
        log("Worked in Ashfall Tavern: +8 gold, +1 Shadow Essence +1 Leather Scraps");
        updateQuestProgressOnCollect("Shadow Essence");
        updateQuestProgressOnCollect("Leather Scraps");
      }
    }

    function blacksmith() {
      const mats = ["Iron Ore","Leather Scraps","Arcane Crystal","Shadow Essence","Ember Core"];
      const needed = mats[player.gearLevel];
      if (player.gold >= 20 && player.gearLevel < 3 && player.inventory[needed] > 0) {
        player.gold -= 20;
        player.inventory[needed]--;
        player.gearLevel++;
        log("Blacksmith upgraded your gear to +" + player.gearLevel + "!");
        // Blacksmith doesn't affect quest progress directly
      } else if (player.gearLevel >= 3) {
        log("Your gear is already maxed out!");
      } else {
        log("Need 20 gold and 1 " + needed + " to upgrade.");
      }
    }

    function rest() {
      if (inCombat) {
        log("You cannot rest during combat.");
        return;
      }
      player.hp = player.maxHp;
      log("You rest at the inn and recover to full health.");
    }

    // --- Quest Board system ---
    function toggleQuestBoard() {
      const board = document.getElementById('questBoard');
      const show = board.style.display === 'none' || board.style.display === '';
      board.style.display = show ? 'block' : 'none';
      if (show) {
        renderQuestList();
        updateAbandonButton();
      }
    }

    function toggleSkillTree() {
      const card = document.getElementById('skillTreeCard');
      const show = card.style.display === 'none' || card.style.display === '';
      card.style.display = show ? 'block' : 'none';
      updateSkillTreeUI();
    }

    function initQuestPool() {
      questPool = [
        { id: 'q_rat_1', title: 'Cull the Rat Caves', type: 'kill', target: 'Rat', count: 10, rewardGold: 20, rewardXp: 15 },
        { id: 'q_rat_2', title: 'Hunt the Mutated Rat', type: 'killNamed', target: 'Mutated Rat', count: 3, rewardGold: 25, rewardXp: 20 },
        { id: 'q_cat_1', title: 'Cleanse the Catacombs', type: 'kill', target: 'Skeleton', count: 8, rewardGold: 30, rewardXp: 25 },
        { id: 'q_cat_2', title: 'Silence the Necromancer', type: 'killNamed', target: 'Necromancer', count: 2, rewardGold: 45, rewardXp: 35 },
        { id: 'q_ash_1', title: 'Quench the Flames', type: 'kill', target: 'Fire', count: 7, rewardGold: 40, rewardXp: 30 },
        { id: 'q_ash_2', title: 'Stone and Ember', type: 'killNamed', target: 'Ash Golem', count: 2, rewardGold: 50, rewardXp: 35 },
        { id: 'q_mat_1', title: 'Gather Iron Ore', type: 'collect', item: 'Iron Ore', count: 5, rewardGold: 18, rewardXp: 12 },
        { id: 'q_mat_2', title: 'Harvest Leather', type: 'collect', item: 'Leather Scraps', count: 6, rewardGold: 22, rewardXp: 14 },
        { id: 'q_mag_1', title: 'Arcane Supplies', type: 'collect', item: 'Arcane Crystal', count: 2, rewardGold: 35, rewardXp: 28 },
        { id: 'q_val_1', title: 'Ancient Tender', type: 'collect', item: 'Ancient Coin', count: 1, rewardGold: 30, rewardXp: 20 },
        { id: 'q_trv_1', title: 'Courier to Ashfall', type: 'travel', town: 'Ashfall', rewardGold: 12, rewardXp: 10 },
        { id: 'q_trv_2', title: 'Courier to Hearthglen', type: 'travel', town: 'Hearthglen', rewardGold: 10, rewardXp: 8 },
        { id: 'q_boss_1', title: 'Forewarned Star', type: 'killNamed', target: 'Vorthalon, Starbinder of Endlight', count: 1, rewardGold: 120, rewardXp: 120 },
        { id: 'q_junk_1', title: 'Clean the Streets', type: 'collect', item: 'Dirty Rag', count: 4, rewardGold: 8, rewardXp: 6 },
        { id: 'q_mix_1', title: 'Ashen Samples', type: 'collect', item: 'Shadow Essence', count: 3, rewardGold: 28, rewardXp: 22 }
      ];
    }

    function refreshQuestsNow() {
      // pick 4 random unique quests
      const indices = new Set();
      while (indices.size < 4 && indices.size < questPool.length) {
        indices.add(Math.floor(Math.random() * questPool.length));
      }
      availableQuests = Array.from(indices).map(i => ({ ...questPool[i], progress: 0 }));
      renderQuestList();
      log('The Quest Board has been updated.');
    }

    function scheduleNextQuestRefresh() {
      if (questRefreshTimer) clearTimeout(questRefreshTimer);
      const minutes = 4 + Math.floor(Math.random() * 3); // 4-6 minutes
      questRefreshTimer = setTimeout(() => {
        refreshQuestsNow();
        scheduleNextQuestRefresh();
      }, minutes * 60 * 1000);
    }

    function renderQuestList() {
      const list = document.getElementById('questList');
      if (!list) return;
      list.innerHTML = '';
      availableQuests.forEach((q, idx) => {
        const canAccept = !activeQuest;
        list.innerHTML += `
          <div style="border:1px dashed #0f0;padding:6px">
            <div><b>${q.title}</b></div>
            <div style="font-size:12px;color:#9f9">${describeQuest(q)}</div>
            <div style="font-size:12px;color:#9f9">Reward: ${q.rewardGold || 0}g, ${q.rewardXp || 0} XP</div>
            <div style="font-size:12px;color:#9f9">Progress: ${q.progress || 0}/${q.count || 1}</div>
            <button onclick="acceptQuest(${idx})" ${canAccept ? '' : 'disabled'}>Accept</button>
          </div>`;
      });
      if (activeQuest) {
        list.innerHTML += `<div style="grid-column:1/-1;border:1px solid #0f0;padding:6px;margin-top:6px">Active: <b>${activeQuest.title}</b> — ${describeQuest(activeQuest)} — Progress: ${activeQuest.progress || 0}/${activeQuest.count || 1}</div>`;
      }
    }

    function describeQuest(q) {
      if (q.type === 'kill') return `Defeat ${q.count} ${q.target}(s).`;
      if (q.type === 'killNamed') return `Defeat ${q.count} ${q.target}.`;
      if (q.type === 'collect') return `Collect ${q.count} ${q.item}.`;
      if (q.type === 'travel') return `Travel to ${q.town}.`;
      return '';
    }

    function acceptQuest(idx) {
      if (activeQuest) { log('You already have an active quest.'); return; }
      if (!availableQuests[idx]) return;
      activeQuest = { ...availableQuests[idx], progress: 0 };
      log('Accepted quest: ' + activeQuest.title);
      renderQuestList();
      updateAbandonButton();
    }

    function tryCompleteQuest() {
      if (!activeQuest) return;
      if (activeQuest.type === 'travel') {
        // Travel quests complete on arrival; handled in travel()
        return;
      }
      if ((activeQuest.type === 'kill' || activeQuest.type === 'killNamed' || activeQuest.type === 'collect') && activeQuest.progress >= (activeQuest.count || 1)) {
        completeActiveQuest();
      }
    }

    function completeActiveQuest() {
      if (!activeQuest) return;
      const g = activeQuest.rewardGold || 0;
      const x = activeQuest.rewardXp || 0;
      player.gold += g;
      player.xp += x;
      log(`Quest complete: ${activeQuest.title} (+${g}g, +${x} XP)`);
      activeQuest = null;
      updateInventory();
      renderQuestList();
      updateAbandonButton();
      
      // Update achievement progress
      if (!achievements.progress["Quest Master"]) achievements.progress["Quest Master"] = 0;
      achievements.progress["Quest Master"]++;
      checkAchievement("Quest Master");
      
      // Update daily challenge progress
      updateDailyChallengeProgress("quest", 1);
    }

    function abandonQuest() {
      if (!activeQuest) { log('No active quest to abandon.'); return; }
      log(`You abandoned the quest: ${activeQuest.title}`);
      activeQuest = null;
      renderQuestList();
      updateAbandonButton();
    }

    function updateAbandonButton() {
      const btn = document.getElementById('abandonQuestBtn');
      if (!btn) return;
      btn.disabled = !activeQuest;
    }
    function updateVorthalonButtonVisibility() {
      const btn = document.getElementById('challengeVorthalonBtn');
      const arenaBtn = document.getElementById('arenaBtn');
      if (btn) {
        const canChallenge = player.town === 'Ashfall' && player.level >= 15;
        btn.style.display = canChallenge ? 'inline-block' : 'none';
      }
      if (arenaBtn) {
        arenaBtn.style.display = player.town === 'Ashfall' ? 'inline-block' : 'none';
      }
    }

    function challengeVorthalon() {
      if (player.town !== 'Ashfall' || player.level < 15) {
        log("You sense a presence, but you are not yet ready.");
        return;
      }
      const enemy = "Vorthalon, Starbinder of Endlight";
      currentEnemy = { name: enemy, hp: 200, dungeon: 'Ashen Rift', arena: false, defeated: false };
      log("You challenge " + enemy + "! HP: " + currentEnemy.hp);
      document.getElementById("enemyBox").textContent = enemyAscii[enemy] || "";
      inCombat = true;
      // Quest progress for accepting the challenge counts as a killNamed only on defeat
    }

    function calculateDrop(dungeonName, playerLevel) {
      const drops = [];
      const dropChance = Math.random();
      
      // Base drop rates based on dungeon difficulty
      let baseChance = 0.3; // 30% base chance
      if (dungeonName === "Old Catacombs") baseChance = 0.4;
      if (dungeonName === "Ashen Rift") baseChance = 0.5;
      
      // Level bonus increases drop chance
      const levelBonus = playerLevel * 0.02; // +2% per level
      const totalChance = Math.min(0.8, baseChance + levelBonus);
      
      if (dropChance <= totalChance) {
        // Determine item rarity based on dungeon and level
        let rarityChance = Math.random();
        let itemRarity = "common";
        
        if (dungeonName === "Rat Caves") {
          if (rarityChance > 0.8 && playerLevel >= 5) itemRarity = "rare";
          else if (rarityChance > 0.6) itemRarity = "uncommon";
        } else if (dungeonName === "Old Catacombs") {
          if (rarityChance > 0.7 && playerLevel >= 10) itemRarity = "rare";
          else if (rarityChance > 0.5) itemRarity = "uncommon";
        } else if (dungeonName === "Ashen Rift") {
          if (rarityChance > 0.6 && playerLevel >= 15) itemRarity = "epic";
          else if (rarityChance > 0.4) itemRarity = "rare";
          else if (rarityChance > 0.2) itemRarity = "uncommon";
        }
        
        // Filter items by rarity and exclude boss weapons from normal drops
        const availableItems = Object.keys(itemPool).filter(item => 
          itemPool[item].rarity === itemRarity && itemPool[item].type !== 'boss_weapon'
        );
        
        if (availableItems.length > 0) {
          const selectedItem = availableItems[Math.floor(Math.random() * availableItems.length)];
          drops.push(selectedItem);
          updateQuestProgressOnCollect(selectedItem);
        }
      }
      
      return drops;
    }

    function calculateVorthalonDrops(playerLevel) {
      const drops = [];
      // Always at least one uncommon item
      const uncommonItems = Object.keys(itemPool).filter(k => itemPool[k].rarity === 'uncommon');
      if (uncommonItems.length > 0) {
        const u = uncommonItems[Math.floor(Math.random() * uncommonItems.length)];
        drops.push(u);
      }
      // 50% chance to add a second uncommon
      if (Math.random() < 0.5 && uncommonItems.length > 0) {
        const u2 = uncommonItems[Math.floor(Math.random() * uncommonItems.length)];
        drops.push(u2);
      }
      // Chance for one boss weapon
      const bossWeapons = Object.keys(itemPool).filter(k => itemPool[k].type === 'boss_weapon');
      // Base 20% + 1% per level over 15 (caps at 40%)
      const weaponChance = Math.min(0.4, 0.2 + Math.max(0, playerLevel - 15) * 0.01);
      if (Math.random() < weaponChance && bossWeapons.length > 0) {
        const w = bossWeapons[Math.floor(Math.random() * bossWeapons.length)];
        drops.push(w);
      }
      return drops;
    }

    function updateQuestProgressOnHit() {
      // reserved for future per-hit quests
    }

    function updateQuestProgressOnKill(enemyName) {
      if (!activeQuest) return;
      if (activeQuest.type === 'kill' && enemyName && enemyName.includes(activeQuest.target)) {
        activeQuest.progress = (activeQuest.progress || 0) + 1;
        renderQuestList();
        tryCompleteQuest();
      } else if (activeQuest.type === 'killNamed' && enemyName === activeQuest.target) {
        activeQuest.progress = (activeQuest.progress || 0) + 1;
        renderQuestList();
        tryCompleteQuest();
      }
    }

    function updateQuestProgressOnCollect(itemName) {
      if (!activeQuest) return;
      if (activeQuest.type === 'collect' && activeQuest.item === itemName) {
        activeQuest.progress = (activeQuest.progress || 0) + 1;
        renderQuestList();
        tryCompleteQuest();
      }
    }

    function enterDungeon(name) {
      log("You enter the " + name + "...");
      let enemies;
      if (name === "Rat Caves") {
        enemies = ["Mutated Rat", "Small Rat", "Rat Gang", "Giant Rat", "Rat Gang(B)", "Skitterspawn"];
      } else if (name === "Old Catacombs") {
        enemies = ["Skeleton", "Ghoul", "Necromancer", "Goblin", "Zombie", "Wraith", "Void Cat Knight", "Shadow Beast", "Angry Leeroy"];
      } else if (name === "Ashen Rift") {
        enemies = ["Fire Imp", "Lava Serpent", "Doomed Paladin", "Ash Golem", "Magma Elemental", "Phoenix", "Crystal Golem"];
      }
      // Add 5 new enemies in Hearthglen dungeons when player.level >= 10
      if (player.town === 'Hearthglen' && player.level >= 10) {
        const hearthglenTier2 = [
          'Bandit Raider', 'Stone Boar', 'Forest Warden', 'Runed Spider', 'Cave Stalker'
        ];
        enemies = enemies.concat(hearthglenTier2);
      }
      const enemy = enemies[Math.floor(Math.random() * enemies.length)];
      currentEnemy = { name: enemy, hp: 30 + player.level * 5, dungeon: name, arena: false, defeated: false };
      log("A " + enemy + " appears! HP: " + currentEnemy.hp);
      document.getElementById("enemyBox").textContent = enemyAscii[enemy] || "";
      inCombat = true;
    }

    // Dungeon Exploration Functions
    function startDungeonExploration() {
      if (inCombat) {
        log("You cannot explore while in combat!");
        return;
      }
      
      // Show dungeon selection
      const dungeonNames = Object.keys(dungeonData);
      const actionsDiv = document.getElementById("dungeonActions");
      actionsDiv.innerHTML = "";
      
      dungeonNames.forEach(dungeonName => {
        const button = document.createElement("button");
        button.textContent = dungeonName;
        button.onclick = () => selectDungeonForExploration(dungeonName);
        actionsDiv.appendChild(button);
      });
      
      document.getElementById("dungeonStatus").textContent = "Select a dungeon to explore:";
      document.getElementById("dungeonDescription").textContent = "Choose your destination carefully. Each dungeon offers unique challenges and rewards.";
      document.getElementById("dungeonMap").textContent = "";
      document.getElementById("dungeonLoot").style.display = "none";
      document.getElementById("dungeonExplorationCard").style.display = "block";
    }

    function selectDungeonForExploration(dungeonName) {
      dungeonExploration.active = true;
      dungeonExploration.currentDungeon = dungeonName;
      dungeonExploration.currentFloor = 1;
      dungeonExploration.currentRoom = 1;
      dungeonExploration.exploredRooms = [];
      dungeonExploration.currentEncounter = null;
      dungeonExploration.lootFound = [];
      dungeonExploration.dialogueState = null;
      
      const dungeon = dungeonData[dungeonName];
      document.getElementById("dungeonStatus").textContent = `${dungeonName} - Floor ${dungeonExploration.currentFloor}, Room ${dungeonExploration.currentRoom}`;
      document.getElementById("dungeonDescription").textContent = dungeon.description;
      
      generateDungeonMap();
      enterCurrentRoom();
    }

    function generateDungeonMap() {
      const mapDiv = document.getElementById("dungeonMap");
      const dungeon = dungeonData[dungeonExploration.currentDungeon];
      const currentFloor = dungeon.floors[dungeonExploration.currentFloor - 1];
      
      let mapText = `Floor ${dungeonExploration.currentFloor}: ${currentFloor.name}\n`;
      mapText += "┌─────────────────┐\n";
      
      for (let room = 1; room <= dungeonExploration.roomsPerFloor; room++) {
        const roomId = `${dungeonExploration.currentFloor}-${room}`;
        const isExplored = dungeonExploration.exploredRooms.includes(roomId);
        const isCurrent = room === dungeonExploration.currentRoom;
        
        if (isCurrent) {
          mapText += "│ [@] ";
        } else if (isExplored) {
          mapText += "│ [✓] ";
        } else {
          mapText += "│ [ ] ";
        }
        
        if (room % 4 === 0) {
          mapText += "│\n";
        }
      }
      
      if (dungeonExploration.roomsPerFloor % 4 !== 0) {
        mapText += "│\n";
      }
      
      mapText += "└─────────────────┘";
      mapDiv.textContent = mapText;
    }

    function enterCurrentRoom() {
      const dungeon = dungeonData[dungeonExploration.currentDungeon];
      const currentFloor = dungeon.floors[dungeonExploration.currentFloor - 1];
      const roomId = `${dungeonExploration.currentFloor}-${dungeonExploration.currentRoom}`;
      
      // Mark room as explored
      if (!dungeonExploration.exploredRooms.includes(roomId)) {
        dungeonExploration.exploredRooms.push(roomId);
      }
      
      // Get random encounter for this room
      const encounters = currentFloor.encounters;
      const encounter = encounters[Math.floor(Math.random() * encounters.length)];
      dungeonExploration.currentEncounter = encounter;
      
      // Update UI
      document.getElementById("dungeonStatus").textContent = 
        `${dungeonExploration.currentDungeon} - Floor ${dungeonExploration.currentFloor}, Room ${dungeonExploration.currentRoom}`;
      document.getElementById("dungeonDescription").textContent = currentFloor.description;
      
      generateDungeonMap();
      handleEncounter(encounter);
    }

    function handleEncounter(encounter) {
      const actionsDiv = document.getElementById("dungeonActions");
      actionsDiv.innerHTML = "";
      
      switch (encounter.type) {
        case "combat":
          const combatBtn = document.createElement("button");
          combatBtn.textContent = "Fight!";
          combatBtn.onclick = () => startDungeonCombat(encounter);
          actionsDiv.appendChild(combatBtn);
          break;
          
        case "loot":
          const lootBtn = document.createElement("button");
          lootBtn.textContent = "Search";
          lootBtn.onclick = () => discoverLoot(encounter);
          actionsDiv.appendChild(lootBtn);
          break;
          
        case "dialogue":
          const dialogueBtn = document.createElement("button");
          dialogueBtn.textContent = "Talk";
          dialogueBtn.onclick = () => startDialogue(encounter);
          actionsDiv.appendChild(dialogueBtn);
          break;
          
        case "boss":
          const bossBtn = document.createElement("button");
          bossBtn.textContent = "Challenge Boss!";
          bossBtn.onclick = () => startBossFight(encounter);
          actionsDiv.appendChild(bossBtn);
          break;
          
        case "exit":
          const exitBtn = document.createElement("button");
          exitBtn.textContent = "Continue Deeper";
          exitBtn.onclick = () => advanceToNextFloor();
          actionsDiv.appendChild(exitBtn);
          break;
      }
      
      // Add navigation buttons
      const navDiv = document.createElement("div");
      navDiv.style.width = "100%";
      navDiv.style.marginTop = "8px";
      
      if (dungeonExploration.currentRoom > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "← Previous Room";
        prevBtn.onclick = () => moveToRoom(dungeonExploration.currentRoom - 1);
        navDiv.appendChild(prevBtn);
      }
      
      if (dungeonExploration.currentRoom < dungeonExploration.roomsPerFloor) {
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next Room →";
        nextBtn.onclick = () => moveToRoom(dungeonExploration.currentRoom + 1);
        navDiv.appendChild(nextBtn);
      }
      
      actionsDiv.appendChild(navDiv);
    }

    function startDungeonCombat(encounter) {
      const enemy = encounter.enemy;
      const hp = 30 + player.level * 5;
      
      currentEnemy = { 
        name: enemy, 
        hp: hp, 
        dungeon: dungeonExploration.currentDungeon, 
        arena: false, 
        defeated: false,
        isDungeonExploration: true
      };
      
      log(encounter.dialogue);
      log("A " + enemy + " appears! HP: " + currentEnemy.hp);
      document.getElementById("enemyBox").textContent = enemyAscii[enemy] || "";
      inCombat = true;
      
      // Hide dungeon exploration UI during combat
      document.getElementById("dungeonExplorationCard").style.display = "none";
    }

    function startBossFight(encounter) {
      const enemy = encounter.enemy;
      let hp = 100 + player.level * 10;
      
      // Special handling for Vorthalon
      if (enemy === "Vorthalon, Starbinder of Endlight") {
        hp = 200;
      }
      
      currentEnemy = { 
        name: enemy, 
        hp: hp, 
        dungeon: dungeonExploration.currentDungeon, 
        arena: false, 
        defeated: false,
        isDungeonExploration: true,
        isBoss: true
      };
      
      log(encounter.dialogue);
      log("A " + enemy + " appears! HP: " + currentEnemy.hp);
      document.getElementById("enemyBox").textContent = enemyAscii[enemy] || "";
      inCombat = true;
      
      // Hide dungeon exploration UI during combat
      document.getElementById("dungeonExplorationCard").style.display = "none";
    }

    function discoverLoot(encounter) {
      const item = encounter.item;
      const description = encounter.description;
      
      // Add to inventory
      if (!player.inventory[item]) {
        player.inventory[item] = 0;
      }
      player.inventory[item]++;
      
      // Show loot with ASCII art
      const lootDiv = document.getElementById("dungeonLoot");
      lootDiv.innerHTML = `
        <div style="text-align:center;margin-bottom:8px">
          <div style="font-family:monospace;color:#ff9;margin-bottom:4px">${lootAscii[item] || ""}</div>
          <div><strong>Found: ${item}</strong></div>
          <div style="font-size:12px;color:#9f9">${description}</div>
        </div>
      `;
      lootDiv.style.display = "block";
      
      // Add to loot found list
      dungeonExploration.lootFound.push(item);
      
      log(`You found: ${item}`);
      log(description);
      
      // Clear actions and show continue button
      const actionsDiv = document.getElementById("dungeonActions");
      actionsDiv.innerHTML = "";
      
      const continueBtn = document.createElement("button");
      continueBtn.textContent = "Continue";
      continueBtn.onclick = () => {
        lootDiv.style.display = "none";
        enterCurrentRoom();
      };
      actionsDiv.appendChild(continueBtn);
    }

    function startDialogue(encounter) {
      const npc = encounter.npc;
      const text = encounter.text;
      
      document.getElementById("dungeonDescription").innerHTML = `
        <div style="color:#9f9;margin-bottom:8px"><strong>${npc}:</strong></div>
        <div style="color:#fff">"${text}"</div>
      `;
      
      // Clear actions and show dialogue options
      const actionsDiv = document.getElementById("dungeonActions");
      actionsDiv.innerHTML = "";
      
      const continueBtn = document.createElement("button");
      continueBtn.textContent = "Continue";
      continueBtn.onclick = () => {
        // Restore normal description
        const dungeon = dungeonData[dungeonExploration.currentDungeon];
        const currentFloor = dungeon.floors[dungeonExploration.currentFloor - 1];
        document.getElementById("dungeonDescription").textContent = currentFloor.description;
        enterCurrentRoom();
      };
      actionsDiv.appendChild(continueBtn);
      
      log(`${npc}: "${text}"`);
    }

    function moveToRoom(roomNumber) {
      dungeonExploration.currentRoom = roomNumber;
      enterCurrentRoom();
    }

    function advanceToNextFloor() {
      if (dungeonExploration.currentFloor < dungeonExploration.maxFloors) {
        dungeonExploration.currentFloor++;
        dungeonExploration.currentRoom = 1;
        log(`You advance to floor ${dungeonExploration.currentFloor}!`);
        enterCurrentRoom();
      } else {
        log("You have reached the deepest part of the dungeon!");
        exitDungeonExploration();
      }
    }

    function exitDungeonExploration() {
      dungeonExploration.active = false;
      document.getElementById("dungeonExplorationCard").style.display = "none";
      log("You exit the dungeon exploration.");
      
      // Show summary of loot found
      if (dungeonExploration.lootFound.length > 0) {
        log(`Dungeon exploration complete! Found: ${dungeonExploration.lootFound.join(", ")}`);
      }
    }

    function combat(action) {
      // strict guard: no actions when no valid target or already defeated
      if (!currentEnemy || !inCombat || currentEnemy.hp <= 0 || currentEnemy.defeated) {
        log("No enemy to fight.");
        return;
      }
      if (action === "attack") {
        let dmg = getPlayerAtk();
        currentEnemy.hp -= dmg;
        log("You attack the " + currentEnemy.name + " for " + dmg + " dmg!");
        updateQuestProgressOnHit();
      }
      if (action === "spell") {
        if (player.inventory["Ember Core"] > 0) {
          let dmg = getPlayerSpell();
          currentEnemy.hp -= dmg;
          log("You cast a spell for " + dmg + " dmg!");
        } else {
          log("You don't have any Ember Cores to cast a spell.");
        }
      }
      if (action === "item") {
        if (player.inventory["Arcane Crystal"] > 0) {
          player.inventory["Arcane Crystal"]--;
          player.hp = Math.min(player.maxHp, player.hp + 20);
          log("You use an Arcane Crystal to restore 20 HP.");
        } else {
          log("No healing items.");
        }
      }
      if (action === "run") {
        if (arena.inArena) {
          log("You cannot flee the arena!");
        } else {
          log("You fled the battle.");
          currentEnemy = null;
          document.getElementById("enemyBox").textContent = "";
          inCombat = false;
          return;
        }
      }

      if (currentEnemy && currentEnemy.hp <= 0 && !currentEnemy.defeated) {
        // mark defeated and clear ASCII immediately to prevent spam
        currentEnemy.defeated = true;
        inCombat = false;
        document.getElementById("enemyBox").textContent = "";
        log("You defeated the " + currentEnemy.name + "!");
        updateQuestProgressOnKill(currentEnemy.name);
        player.xp += 10;
        player.gold += 5;
        log("+10 XP, +5 gold.");
        
        // Update achievement progress for kills
        if (currentEnemy.name.toLowerCase().includes('rat')) {
          if (!achievements.progress["Rat Slayer"]) achievements.progress["Rat Slayer"] = 0;
          achievements.progress["Rat Slayer"]++;
          checkAchievement("Rat Slayer");
        }
        
        // Update daily challenge progress for kills
        updateDailyChallengeProgress("kill", 1);
        
        // Arena vs Boss vs Normal rewards
        if (currentEnemy.name === "Vorthalon, Starbinder of Endlight") {
          const drops = calculateVorthalonDrops(player.level);
          grantDrops(drops);
          checkAchievement("Boss Slayer");
        } else if (currentEnemy.arena) {
          handleArenaWin();
        } else if (currentEnemy.isDungeonExploration) {
          // Handle dungeon exploration combat rewards
          if (currentEnemy.isBoss) {
            const drops = calculateDrop(currentEnemy.dungeon, player.level);
            grantDrops(drops);
            log("Boss defeated! You can now advance to the next floor.");
          } else {
            const drops = calculateDrop(currentEnemy.dungeon, player.level);
            grantDrops(drops);
          }
          
          // Return to dungeon exploration
          if (dungeonExploration.active) {
            document.getElementById("dungeonExplorationCard").style.display = "block";
            // Continue with current room exploration
            enterCurrentRoom();
          }
        } else {
          const drops = calculateDrop(currentEnemy.dungeon, player.level);
          grantDrops(drops);
        }
        
        if (player.xp >= player.level * 20) {
          player.level++;
          log("Level up! You are now level " + player.level);
          updateVorthalonButtonVisibility();
          awardSkillPointOnLevel();
        }
        
        // Check for First Blood achievement
        checkAchievement("First Blood");
        currentEnemy = null;
      } else {
        let base = 5;
        if (currentEnemy && currentEnemy.arena) base = Math.max(6, 4 + arena.wave * 2);
        let dmg = base;
        player.hp -= dmg;
        log("The " + currentEnemy.name + " hits you for " + dmg + " dmg. HP: " + player.hp);
        if (player.hp <= 0) {
          log("You have been defeated...Heading back to Town");
          player.hp = player.maxHp;
          player.gold = Math.max(0, player.gold - 5);
          currentEnemy = null;
          document.getElementById("enemyBox").textContent = "";
          inCombat = false;
          if (arena.inArena) {
            arena.inArena = false;
            arena.mode = null;
            arena.wave = 0;
            renderArenaUI();
          }
          // Exit dungeon exploration if active
          if (dungeonExploration.active) {
            exitDungeonExploration();
          }
        }
      }
    }

    function travel(destination) {
      if (destination === "Ashfall" && player.level < 15) {
        log("Ashfall is too dangerous until you reach level 15!");
        return;
      }
      player.town = destination;
      document.getElementById("townAscii").textContent = townAsciiArt[destination];
      log("You travel to " + destination + ".");
      updateVorthalonButtonVisibility();
      // Travel quest completion
      if (activeQuest && activeQuest.type === 'travel' && activeQuest.town === destination) {
        completeActiveQuest();
      }
      // Arena panel re-render if visible
      renderArenaUI();
    }

    // --- Shop system ---
    function refreshShop() {
      const allItems = Object.keys(itemPool).filter(k => itemPool[k].type !== 'boss_weapon');
      shopItems = [];
      for (let i = 0; i < 4; i++) {
        const item = allItems[Math.floor(Math.random() * allItems.length)];
        const basePrice = itemPool[item].value;
        const price = Math.floor(basePrice * (0.8 + Math.random() * 0.4)); // 80-120% of base value
        shopItems.push({ name: item, price });
      }
      updateShop();
    }

    // --- Skills logic ---
    function updateSkillTreeUI() {
      const pts = document.getElementById('skillPointsLabel');
      const p = document.getElementById('skillPowerVal');
      const f = document.getElementById('skillFocusVal');
      const v = document.getElementById('skillVitalityVal');
      const picker = document.getElementById('classPicker');
      if (pts) pts.textContent = String(skillState.pointsUnspent);
      if (p) p.textContent = String(skillState.power);
      if (f) f.textContent = String(skillState.focus);
      if (v) v.textContent = String(skillState.vitality);
      if (picker && picker.value !== skillState.className) picker.value = skillState.className;
    }

    function setPlayerClass(value) {
      skillState.className = value;
      log('Class set to ' + value + '.');
      updateSkillTreeUI();
    }

    function allocatePoint(stat) {
      if (skillState.pointsUnspent <= 0) { log('No skill points available.'); return; }
      if (stat === 'power') {
        skillState.power++;
      } else if (stat === 'focus') {
        skillState.focus++;
      } else if (stat === 'vitality') {
        skillState.vitality++;
        player.maxHp += 5;
        player.hp = Math.min(player.hp + 5, player.maxHp);
      }
      skillState.pointsUnspent--;
      updateSkillTreeUI();
    }

    function awardSkillPointOnLevel() {
      // Award 1 point per level up
      skillState.pointsUnspent++;
      updateSkillTreeUI();
    }

    function updateShop() {
      const shopBox = document.getElementById("shopGrid");
      shopBox.innerHTML = "";
      shopItems.forEach((item, idx) => {
        shopBox.innerHTML += `
          <div>
            ${item.name} - ${item.price}g 
            <button onclick="buyItem(${idx})">Buy</button>
            <button onclick="sellItem('${item.name}', ${item.price})">Sell</button>
          </div>`;
      });
    }

    function buyItem(index) {
      const item = shopItems[index];
      if (player.gold >= item.price) {
        player.gold -= item.price;
        if (!player.inventory[item.name]) player.inventory[item.name] = 0;
        player.inventory[item.name]++;
        log("Bought 1 " + item.name + " for " + item.price + " gold.");
        updateQuestProgressOnCollect(item.name);
        updateInventory();
      } else {
        log("Not enough gold!");
      }
    }

    function sellItem(name, price) {
      if (player.inventory[name] > 0) {
        player.inventory[name]--;
        const sellPrice = itemPool[name] ? Math.floor(itemPool[name].value * 0.6) : Math.floor(price / 2);
        player.gold += sellPrice;
        log("Sold 1 " + name + " for " + sellPrice + " gold.");
        // Selling doesn't count as collecting; no quest progress here
        updateInventory();
      } else {
        log("You don't have any " + name + " to sell.");
      }
    }

    // --- Shared drop grant helper ---
    function grantDrops(drops) {
      if (drops && drops.length > 0) {
        drops.forEach(item => {
          if (!player.inventory[item]) {
            player.inventory[item] = 0;
          }
          player.inventory[item]++;
          log("Found: " + item + " (Value: " + (itemPool[item] ? itemPool[item].value : '?') + "g)");
        });
      }
      updateInventory();
    }

    // --- Arena UI and logic ---
    function toggleArena() {
      const card = document.getElementById('arenaCard');
      const show = card.style.display === 'none' || card.style.display === '';
      card.style.display = show ? 'block' : 'none';
      renderArenaUI();
    }

    function renderArenaUI() {
      const status = document.getElementById('arenaStatus');
      const actions = document.getElementById('arenaActions');
      if (!status || !actions) return;
      if (player.town !== 'Ashfall') {
        status.textContent = "You must be in Ashfall to enter the Arena.";
        actions.innerHTML = "";
        return;
      }
      const need = 20;
      arena.unlocked = arena.rep >= need;
      status.innerHTML = `Arena Rep: <b>${arena.rep}</b> / ${need} — ${arena.unlocked ? 'Unlocked' : 'Locked'}`;
      if (!arena.unlocked) {
        actions.innerHTML = `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div><b>Arena Task</b></div>
            <div style="font-size:12px;color:#9f9">Deliver supplies to the Arena Master (+5 Rep)</div>
            <button onclick="doArenaTask()">Do Task</button>
          </div>`;
      } else if (!arena.inArena) {
        actions.innerHTML = `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div><b>Duel</b> — Fight a single gladiator.</div>
            <button onclick="startArenaDuel()">Enter Duel</button>
          </div>
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div><b>Waves</b> — Survive escalating waves.</div>
            <button onclick="startArenaWaves()">Enter Waves</button>
          </div>`;
      } else {
        actions.innerHTML = `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div>In Arena: <b>${arena.mode === 'duel' ? 'Duel' : 'Waves (Wave ' + arena.wave + ')'}</b></div>
            <div>Defeat your opponent to proceed.</div>
          </div>`;
      }
    }

    function doArenaTask() {
      if (player.town !== 'Ashfall') { log("You're not in Ashfall."); return; }
      arena.rep = Math.min(999, arena.rep + 5);
      log("You delivered supplies to the Arena Master. +5 Arena Rep.");
      renderArenaUI();
    }

    function startArenaDuel() {
      if (!arena.unlocked) { log("The Arena is locked."); return; }
      arena.inArena = true;
      arena.mode = 'duel';
      arena.wave = 1;
      const gladiators = ["Gladiator Brutus", "Gladiator Nyx", "Arena Crusher"];
      const name = gladiators[Math.floor(Math.random() * gladiators.length)];
      const hp = 50 + player.level * 7;
      currentEnemy = { name, hp, dungeon: 'Arena', arena: true, defeated: false };
      log("Arena Duel begins! Opponent: " + name + " (HP: " + hp + ")");
      document.getElementById("enemyBox").textContent = enemyAscii[name] || "";
      inCombat = true;
      renderArenaUI();
    }

    function startArenaWaves() {
      if (!arena.unlocked) { log("The Arena is locked."); return; }
      arena.inArena = true;
      arena.mode = 'waves';
      arena.wave = 0;
      nextArenaWave();
    }

    function nextArenaWave() {
      arena.wave++;
      const wavePool = ["Gladiator Brutus", "Gladiator Nyx", "Arena Crusher"];
      const name = wavePool[Math.floor(Math.random() * wavePool.length)];
      const hp = 40 + player.level * 5 + arena.wave * 10;
      currentEnemy = { name, hp, dungeon: 'Arena', arena: true, defeated: false };
      log("Arena Wave " + arena.wave + ": " + name + " (HP: " + hp + ")");
      document.getElementById("enemyBox").textContent = enemyAscii[name] || "";
      inCombat = true;
      renderArenaUI();
    }

    function handleArenaWin() {
      if (arena.mode === 'duel') {
        giveArenaReward('duel');
        log("You won the duel! Return to the arena board for another challenge.");
        arena.inArena = false;
        arena.mode = null;
        arena.wave = 0;
        renderArenaUI();
      } else if (arena.mode === 'waves') {
        giveArenaReward('wave', arena.wave);
        if (arena.wave >= 5) {
          log("You conquered 5 waves and are hailed as a champion!");
          arena.inArena = false;
          arena.mode = null;
          arena.wave = 0;
          renderArenaUI();
        } else {
          nextArenaWave();
        }
      }
      
      // Update achievement progress for arena wins
      if (!achievements.progress["Arena Champion"]) achievements.progress["Arena Champion"] = 0;
      achievements.progress["Arena Champion"]++;
      checkAchievement("Arena Champion");
      
      // Update daily challenge progress for arena wins
      updateDailyChallengeProgress("arena", 1);
    }

    function giveArenaReward(kind, wave = 1) {
      let rewards = [];
      if (kind === 'duel') {
        rewards.push("Arena Token");
        if (Math.random() < 0.2) rewards.push("Champion's Laurel");
        player.gold += 15;
        player.xp += 12;
        log("+12 XP, +15 gold (Arena Reward).");
      } else {
        const tokens = 1 + Math.floor(wave / 2);
        for (let i = 0; i < tokens; i++) rewards.push("Arena Token");
        if (wave >= 3 && Math.random() < 0.35) rewards.push("Champion's Laurel");
        const g = 8 + wave * 4;
        const x = 8 + wave * 5;
        player.gold += g;
        player.xp += x;
        log("Wave reward: +" + x + " XP, +" + g + " gold.");
      }
      grantDrops(rewards);
    }

    // --- Save/Load system (3 slots, localStorage) ---
    function toggleSaveMenu() {
      const m = document.getElementById('saveMenu');
      const show = m.style.display === 'none' || m.style.display === '';
      m.style.display = show ? 'block' : 'none';
      if (show) renderSaveSlots();
    }
    function closeSaveMenu() {
      const m = document.getElementById('saveMenu');
      m.style.display = 'none';
    }
    function slotKey(n) { return 'ascii_rpg_save_slot_' + n; }
    function renderSaveSlots() {
      const box = document.getElementById('saveSlots');
      if (!box) return;
      let html = '';
      for (let i = 1; i <= 3; i++) {
        const exists = !!localStorage.getItem(slotKey(i));
        html += `
          <div style="display:flex;align-items:center;justify-content:space-between;margin:4px 0">
            <span>Slot ${i}: ${exists ? '<span style="color:#9f9">Saved</span>' : '<span style="color:#f99">Empty</span>'}</span>
            <span>
              <button onclick="saveToSlot(${i})">Save</button>
              <button onclick="loadFromSlot(${i})" ${exists ? '' : 'disabled'}>Load</button>
              <button onclick="deleteSlot(${i})" ${exists ? '' : 'disabled'}>Delete</button>
            </span>
          </div>`;
      }
      box.innerHTML = html;
    }
    function gameState() {
      return {
        player,
        skillState,
        arena,
        activeQuest,
        availableQuests,
        questPool,
        shopItems,
        townAscii: player.town,
        achievements,
        pets,
        crafting,
        dailyChallenges,
        prestige
      };
    }
    function applyGameState(s) {
      if (!s) return;
      player = s.player;
      skillState = s.skillState;
      arena = s.arena || arena;
      activeQuest = s.activeQuest || null;
      availableQuests = s.availableQuests || [];
      questPool = s.questPool || questPool;
      shopItems = s.shopItems || shopItems;
      achievements = s.achievements || achievements;
      pets = s.pets || pets;
      crafting = s.crafting || crafting;
      dailyChallenges = s.dailyChallenges || dailyChallenges;
      prestige = s.prestige || prestige;
      
      document.getElementById("townAscii").textContent = townAsciiArt[player.town];
      updateInventory();
      updateVorthalonButtonVisibility();
      renderQuestList();
      updateAbandonButton();
      updateShop();
      updateSkillTreeUI();
      renderArenaUI();
      log("Game state loaded.");
    }
    function saveToSlot(n) {
      try {
        localStorage.setItem(slotKey(n), JSON.stringify(gameState()));
        log("Saved to slot " + n + ".");
        renderSaveSlots();
      } catch (e) {
        log("Save failed: " + e.message);
      }
    }
    function loadFromSlot(n) {
      try {
        const raw = localStorage.getItem(slotKey(n));
        if (!raw) { log("No save in slot " + n + "."); return; }
        const s = JSON.parse(raw);
        applyGameState(s);
      } catch (e) {
        log("Load failed: " + e.message);
      }
    }
    function deleteSlot(n) {
      localStorage.removeItem(slotKey(n));
      log("Deleted slot " + n + ".");
      renderSaveSlots();
    }

    // --- Equipment equipping ---
    function equipWeapon(name) {
      if (!itemPool[name] || itemPool[name].type !== 'boss_weapon') {
        log("That cannot be equipped as a weapon.");
        return;
      }
      if (!player.inventory[name] || player.inventory[name] <= 0) {
        log("You don't own " + name + ".");
        return;
      }
      player.equipment.weapon = name;
      log("Equipped weapon: " + name + ".");
      updateInventory();
      const ep = document.getElementById('equipmentPanel');
      if (ep && ep.style.display !== 'none') renderEquipmentWindow();
    }

    // --- Equipment window ---
    function toggleEquipmentWindow() {
      const panel = document.getElementById('equipmentPanel');
      if (!panel) return;
      const show = panel.style.display === 'none' || panel.style.display === '';
      panel.style.display = show ? 'block' : 'none';
      if (show) renderEquipmentWindow();
    }

    // Player stats with pet bonuses
    function getPlayerAtk() {
      let atk = 5 + player.gearLevel * 2 + skillState.power;
      if (player.equipment.weapon) atk += 15;
      
      // Pet bonuses
      if (pets.active && petTypes[pets.active]) {
        const pet = petTypes[pets.active];
        if (pet.bonus.attack) atk += pet.bonus.attack;
        if (pet.bonus.all) atk += pet.bonus.all;
      }
      
      return atk;
    }

    function getPlayerSpell() {
      let spell = 8 + skillState.focus;
      
      // Pet bonuses
      if (pets.active && petTypes[pets.active]) {
        const pet = petTypes[pets.active];
        if (pet.bonus.spell) spell += pet.bonus.spell;
        if (pet.bonus.all) spell += pet.bonus.all;
      }
      
      return spell;
    }

    function getPlayerDef() {
      let def = 2 + Math.floor(player.gearLevel / 2);
      
      // Pet bonuses
      if (pets.active && petTypes[pets.active]) {
        const pet = petTypes[pets.active];
        if (pet.bonus.defense) def += pet.bonus.defense;
        if (pet.bonus.all) def += pet.bonus.all;
      }
      
      return def;
    }

    // --- Pet System ---
    function togglePetSystem() {
      const card = document.getElementById('petCard');
      const show = card.style.display === 'none' || card.style.display === '';
      card.style.display = show ? 'block' : 'none';
      if (show) renderPetSystem();
    }

    function renderPetSystem() {
      const status = document.getElementById('petStatus');
      const actions = document.getElementById('petActions');
      
      if (!pets.active) {
        status.innerHTML = '<span style="color:#f99">No pet active</span>';
        actions.innerHTML = `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div><b>Adopt a Pet</b></div>
            <button onclick="adoptPet('Wolf Pup')">Wolf Pup (50 gold)</button>
            <button onclick="adoptPet('Mystic Cat')">Mystic Cat (75 gold)</button>
            <button onclick="adoptPet('Guardian Owl')">Guardian Owl (60 gold)</button>
            <button onclick="adoptPet('Dragon Hatchling')">Dragon Hatchling (200 gold)</button>
          </div>
        `;
      } else {
        const pet = petTypes[pets.active];
        const happiness = Math.max(0, pets.happiness);
        status.innerHTML = `
          <div style="white-space:pre;text-align:center;margin-bottom:4px">${pet.ascii}</div>
          <div><b>${pets.active}</b> - Happiness: ${happiness}%</div>
        `;
        actions.innerHTML = `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div><b>Pet Actions</b></div>
            <button onclick="feedPet()">Feed Pet Treat</button>
            <button onclick="playWithPet()">Play with Pet</button>
            <button onclick="dismissPet()">Dismiss Pet</button>
          </div>
        `;
      }
    }

    function adoptPet(petName) {
      const cost = { "Wolf Pup": 50, "Mystic Cat": 75, "Guardian Owl": 60, "Dragon Hatchling": 200 }[petName];
      if (player.gold < cost) {
        log("Not enough gold to adopt " + petName + "!");
        return;
      }
      if (pets.owned.includes(petName)) {
        log("You already own a " + petName + "!");
        return;
      }
      
      player.gold -= cost;
      pets.owned.push(petName);
      pets.active = petName;
      pets.happiness = 100;
      pets.lastFed = Date.now();
      
      log("Adopted " + petName + " for " + cost + " gold!");
      updateInventory();
      renderPetSystem();
      checkAchievement("Pet Lover");
      
      // Update achievement progress for pet ownership
      if (!achievements.progress["Pet Lover"]) achievements.progress["Pet Lover"] = 0;
      achievements.progress["Pet Lover"]++;
      checkAchievement("Pet Lover");
    }

    function feedPet() {
      if (!pets.active) return;
      if (!player.inventory["Pet Treat"] || player.inventory["Pet Treat"] <= 0) {
        log("You need a Pet Treat to feed your pet!");
        return;
      }
      
      player.inventory["Pet Treat"]--;
      pets.happiness = Math.min(100, pets.happiness + 25);
      pets.lastFed = Date.now();
      
      log("Fed your pet! Happiness increased!");
      updateInventory();
      renderPetSystem();
      updateDailyChallengeProgress("feed", 1);
      
      // Update daily challenge progress for pet feeding
      updateDailyChallengeProgress("feed", 1);
    }

    function playWithPet() {
      if (!pets.active) return;
      pets.happiness = Math.min(100, pets.happiness + 15);
      log("Played with your pet! Happiness increased!");
      renderPetSystem();
    }

    function dismissPet() {
      if (!pets.active) return;
      pets.active = null;
      log("Dismissed your pet.");
      renderPetSystem();
    }

    // --- Crafting System ---
    function toggleCrafting() {
      const card = document.getElementById('craftingCard');
      const show = card.style.display === 'none' || card.style.display === '';
      card.style.display = show ? 'block' : 'none';
      if (show) renderCrafting();
    }

    function renderCrafting() {
      const recipes = document.getElementById('craftingRecipes');
      let html = '';
      
      for (const [recipeName, recipe] of Object.entries(craftingRecipes)) {
        const canCraft = canCraftRecipe(recipe);
        const materialsList = Object.entries(recipe.materials)
          .map(([item, count]) => `${item}: ${player.inventory[item] || 0}/${count}`)
          .join(', ');
        
        html += `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div><b>${recipeName}</b></div>
            <div style="font-size:12px;color:#9f9">${recipe.result.name}</div>
            <div style="font-size:11px;margin:4px 0">Materials: ${materialsList}</div>
            <button onclick="craftItem('${recipeName}')" ${canCraft ? '' : 'disabled'}>
              ${canCraft ? 'Craft' : 'Missing Materials'}
            </button>
          </div>
        `;
      }
      
      recipes.innerHTML = html;
    }

    function canCraftRecipe(recipe) {
      for (const [item, count] of Object.entries(recipe.materials)) {
        if (!player.inventory[item] || player.inventory[item] < count) return false;
      }
      return true;
    }

    function craftItem(recipeName) {
      const recipe = craftingRecipes[recipeName];
      if (!recipe) return;
      
      if (!canCraftRecipe(recipe)) {
        log("Missing materials to craft " + recipeName + "!");
        return;
      }
      
      // Consume materials
      for (const [item, count] of Object.entries(recipe.materials)) {
        player.inventory[item] -= count;
      }
      
      // Add crafted item
      const result = recipe.result;
      if (!player.inventory[result.name]) player.inventory[result.name] = 0;
      player.inventory[result.name]++;
      
      log("Crafted " + result.name + "!");
      updateInventory();
      renderCrafting();
      checkAchievement("Craftsman");
      updateDailyChallengeProgress("craft", 1);
      
      // Update achievement progress for crafting
      if (!achievements.progress["Craftsman"]) achievements.progress["Craftsman"] = 0;
      achievements.progress["Craftsman"]++;
      checkAchievement("Craftsman");
    }

    // --- Achievement System ---
    function toggleAchievements() {
      const card = document.getElementById('achievementsCard');
      const show = card.style.display === 'none' || card.style.display === '';
      card.style.display = show ? 'block' : 'none';
      if (show) renderAchievements();
    }

    function renderAchievements() {
      const list = document.getElementById('achievementsList');
      let html = '';
      
      for (const [id, achievement] of Object.entries(achievementList)) {
        const unlocked = achievements.unlocked.includes(id);
        const progress = achievements.progress[id] || 0;
        const hasProgress = achievement.progress;
        
        html += `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center;${unlocked ? 'background:#0a0a0a' : ''}">
            <div><b>${achievement.name}</b></div>
            <div style="font-size:12px;color:#9f9">${achievement.desc}</div>
            ${hasProgress ? `<div style="font-size:11px;margin:4px 0">Progress: ${progress}/${achievement.progress.count}</div>` : ''}
            <div style="font-size:11px;color:${unlocked ? '#9f9' : '#f99'}">
              ${unlocked ? '✓ UNLOCKED' : '🔒 LOCKED'}
            </div>
          </div>
        `;
      }
      
      list.innerHTML = html;
    }

    function checkAchievement(achievementId) {
      if (achievements.unlocked.includes(achievementId)) return;
      
      const achievement = achievementList[achievementId];
      if (!achievement) return;
      
      if (achievement.progress) {
        const progress = achievements.progress[achievementId] || 0;
        if (progress < achievement.progress.count) return;
      }
      
      // Unlock achievement
      achievements.unlocked.push(achievementId);
      const reward = achievement.reward;
      
      if (reward.gold) player.gold += reward.gold;
      if (reward.xp) player.xp += reward.xp;
      if (reward.item) {
        if (!player.inventory[reward.item]) player.inventory[reward.item] = 0;
        player.inventory[reward.item]++;
      }
      
      log("🏆 ACHIEVEMENT UNLOCKED: " + achievement.name + "!");
      if (reward.gold) log("Reward: " + reward.gold + " gold");
      if (reward.xp) log("Reward: " + reward.xp + " XP");
      if (reward.item) log("Reward: " + reward.item);
      
      updateInventory();
      renderAchievements();
    }

    // --- Daily Challenges ---
    function toggleDailyChallenges() {
      const card = document.getElementById('dailyChallengesCard');
      const show = card.style.display === 'none' || card.style.display === '';
      card.style.display = show ? 'block' : 'none';
      if (show) renderDailyChallenges();
    }

    function renderDailyChallenges() {
      const status = document.getElementById('dailyChallengeStatus');
      const actions = document.getElementById('dailyChallengesActions');
      
      if (!dailyChallenges.current) {
        status.innerHTML = '<span style="color:#f99">No daily challenge active</span>';
        actions.innerHTML = `
          <div style="border:1px dashed #0f0;padding:6px;text-align:center">
            <div><b>Get New Challenge</b></div>
            <button onclick="startDailyChallenge()">Start Daily Challenge</button>
          </div>
        `;
      } else {
        const challenge = dailyChallengeTypes[dailyChallenges.current];
        const progress = dailyChallenges.progress || 0;
        const completed = progress >= challenge.target;
        
        status.innerHTML = `
          <div><b>${challenge.name}</b></div>
          <div style="font-size:12px;color:#9f9">${challenge.desc}</div>
          <div style="font-size:11px;margin:4px 0">Progress: ${progress}/${challenge.target}</div>
          <div style="font-size:11px;color:${completed ? '#9f9' : '#f99'}">
            ${completed ? '✓ COMPLETED' : '🔄 IN PROGRESS'}
          </div>
        `;
        
        if (completed) {
          actions.innerHTML = `
            <div style="border:1px dashed #0f0;padding:6px;text-align:center">
              <div><b>Challenge Complete!</b></div>
              <button onclick="claimDailyReward()">Claim Reward</button>
            </div>
          `;
        } else {
          actions.innerHTML = `
            <div style="border:1px dashed #0f0;padding:6px;text-align:center">
              <div><b>Keep Going!</b></div>
              <div style="font-size:11px;color:#9f9">Complete the challenge to earn rewards</div>
            </div>
          `;
        }
      }
    }

    function startDailyChallenge() {
      const challengeKeys = Object.keys(dailyChallengeTypes);
      const randomChallenge = challengeKeys[Math.floor(Math.random() * challengeKeys.length)];
      
      dailyChallenges.current = randomChallenge;
      dailyChallenges.progress = 0;
      dailyChallenges.lastRefresh = Date.now();
      
      log("🎯 New daily challenge started: " + dailyChallengeTypes[randomChallenge].name);
      renderDailyChallenges();
    }

    function updateDailyChallengeProgress(type, amount = 1) {
      if (!dailyChallenges.current) return;
      
      const challenge = dailyChallengeTypes[dailyChallenges.current];
      if (challenge.type === type) {
        dailyChallenges.progress = (dailyChallenges.progress || 0) + amount;
        renderDailyChallenges();
      }
    }

    function claimDailyReward() {
      if (!dailyChallenges.current) return;
      
      const challenge = dailyChallengeTypes[dailyChallenges.current];
      const reward = challenge.reward;
      
      if (reward.gold) player.gold += reward.gold;
      if (reward.xp) player.xp += reward.xp;
      if (reward.item) {
        if (!player.inventory[reward.item]) player.inventory[reward.item] = 0;
        player.inventory[reward.item]++;
      }
      
      dailyChallenges.streak++;
      dailyChallenges.current = null;
      dailyChallenges.progress = 0;
      
      log("🎁 Daily challenge reward claimed!");
      if (reward.gold) log("Gold: +" + reward.gold);
      if (reward.xp) log("XP: +" + reward.xp);
      if (reward.item) log("Item: " + reward.item);
      
      updateInventory();
      renderDailyChallenges();
    }

    // --- Initialization Functions ---
    function initAchievements() {
      // Check for first blood achievement
      if (achievements.unlocked.length === 0) {
        checkAchievement("First Blood");
      }
    }

    function initPets() {
      // Pet happiness decay timer
      setInterval(() => {
        if (pets.active && petTypes[pets.active]) {
          const pet = petTypes[pets.active];
          pets.happiness = Math.max(0, pets.happiness - pet.happinessDecay);
          if (pets.happiness <= 0) {
            log("Your pet is very unhappy and has run away!");
            pets.active = null;
            renderPetSystem();
          }
        }
      }, 60000); // Check every minute
    }

    function initCrafting() {
      // Initialize crafting recipes
      crafting.recipes = craftingRecipes;
    }

    function initDailyChallenges() {
      // Check if daily challenge should refresh
      const now = Date.now();
      const lastRefresh = dailyChallenges.lastRefresh;
      const oneDay = 24 * 60 * 60 * 1000;
      
      if (now - lastRefresh >= oneDay) {
        dailyChallenges.current = null;
        dailyChallenges.progress = 0;
      }
    }

    function renderEquipmentWindow() {
      const body = document.getElementById('equipmentPanelBody');
      if (!body) return;
      const armorTier = player.gearLevel;
      const armorLabel = ["Ragged Clothes","Iron Gear","Reinforced Gear","Masterwork Gear","Fully upgraded Gear"][armorTier];
      const weapon = player.equipment.weapon ? player.equipment.weapon : "None";
      const owned = Object.keys(itemPool).filter(k => itemPool[k].type === 'boss_weapon' && player.inventory[k] > 0);
      let equipButtons = '';
      if (owned.length > 0) {
        equipButtons = owned.map(w => `<button onclick="equipWeapon('${w}')" style="max-width:none;width:auto;margin:2px 0">${w}</button>`).join('<br>');
      } else {
        equipButtons = '<span style="color:#9f9">No boss weapons owned.</span>';
      }
      const ascii = [
        "   O   ",
        "  /|\\  ",
        "  / \\  "
      ].join("\\n");
      body.innerHTML = `
        <div style="white-space:pre;text-align:center;margin-bottom:4px">${ascii}</div>
        <div>Armor: <b>${armorLabel}</b></div>
        <div>Weapon: <b>${weapon}</b></div>
        <div style="margin-top:6px;border-top:1px dashed #0f0;padding-top:6px">
          <div style="text-align:center"><b>Equip Boss Weapon</b></div>
          <div style="text-align:center">${equipButtons}</div>
        </div>
      `;
    }

    // Init
    refreshShop();
    setInterval(refreshShop, 300000);

    // Initialize new systems
    initAchievements();
    initPets();
    initCrafting();
    initDailyChallenges();

    updateInventory();
    updateVorthalonButtonVisibility();
    initQuestPool();
    refreshQuestsNow();
    scheduleNextQuestRefresh();
    updateAbandonButton();
    updateSkillTreeUI();
    renderSaveSlots();
  </script>
</body>
</html>
